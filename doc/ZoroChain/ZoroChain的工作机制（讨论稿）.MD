# ZoroChain的工作机制（讨论稿）
#### 根链和应用链
* 根链做为管理链，负责所有应用链管理，以及全局资产管理
* 每个上链的应用有专属的一条应用链，负责记录和该应用有关的所有交易

#### 创建应用链
* 创建应用链需要一定的系统费用
* 用交易记账的流程来创建应用链
* 某个节点收到一个创建应用链的交易请求
* 该节点广播该交易并等待共识
* 共识节点通过共识后，将该交易写入根链
* 其他节点在同步根链时，能获知当前已建立的所有应用链的信息

#### 创建应用链消息
* 创建应用链的消息需要包括以下内容
  * 应用链的名称和Hash
  * 网络端口号
  * 记账人地址，最少4个
  * 种子节点的域名和端口

#### 验证创建应用链的消息
* 应用链的Hash必须唯一，名称可以重复
* 网络端口不必唯一，可以和其他应用重复
* 不验证种子节点是否有效

#### 删除应用链
* 暂时不提供删除应用链的操作

#### 应用链的管理权限
* 应用链会有一套操作权限管理机制，例如更改记账人、更改记账费率、超级管理员等
* 应用链的创建者会成为默认的超级管理员，拥有全部操作的权限以及对其他管理员的管理权限
* 可以通过权限管理的相关交易，动态增删应用链的管理员和修改其对应的权限

#### 应用链的记账人
* 创建应用链的交易数据里，需要指定初始的记账人地址和种子节点地址，现阶段需要最少4个记账人
* 在验证了提供的记账人地址有效以后，才能成功创建应用链，否则该交易会失败
* 会有调整记账人的相关交易用来对记账人进行动态的调整

#### 应用链的记账费用
* 每个应用链有一个GasCoinPool，在该链进行共识出块时，会从GasCoinPool中扣掉所有需要记账的交易的费用总和
* 如果GasCoinPool中的金额不够支付记账费用，则无法进行共识出块
* 扣除的记账费用，会按预定规则分配给参与本次共识的记账人节点（先按照平均分配的方式）
* 每个应用链可以自主设定记账费用相对于Zoro BCP的兑换比例，以此控制本应用链的记账费用高低，吸引更多的矿工节点参与记账

#### 节点配置需要关注的应用链
* 每个节点可以在配置文件中自由配置需要关注的应用链
* 节点启动后可以用指令动态更改自身关注的应用链，对应的列表会被保存到配置文件中
* 节点启动后，先同步根链的区块，之后会同步关注的应用链区块

#### 节点参与应用链的记账
* 在第一个版本里，暂时不提供记账人的竞争和投票机制
* 在创建应用链时，指定了默认的记账人地址，如果之后没有变更操作，他们作为该应用链的记账人

#### P2P网络的连接结构
* 为每一种应用链单独组建一套P2P网络连接，避免一条应用链阻塞后对其他应用链造成影响
* 每条应用链在创建时，需要指定一个和其他应用链不重复的网络端口
* 理论上每个节点关注的应用链数量不会太多（最多5个左右），因此每个节点连接数量也不会太多（最多50个左右）
 
#### 数据存储的机制
* 每一条链会有一个对应的LevelDB数据库，在各自独立的线程里进行数据存储


### 有待讨论
#### 根链的记账候选人
* 采用类似NEO的机制，由官方指定N个备选人，其他节点可以投票选举其他账户作为备选人
* 得票数高的备选人会成为的记账人

#### 应用链的记账候选人
* 由应用链的创建者指定N个备选人
* 可以由管理员通过交易来修改备选人

#### 根链的创世块
* 采用和NEO相同的机制，每个节点在启动后，如果数据库中没有数据则立刻创建并保存创世块
* 在根链的创世块里进行Zoro BCP的初始登记和分配

#### 应用链的创世块
* 是否需要在创始块中登记分配货币？

#### 应用链的端口重复
* 应用链的端口可以和其他应用相同
* 同一个节点上不允许跑两个端口重复应用

#### 是否需要定时出块
* 设定最短出块时间和最长出块时间
* 如果有交易要出块，就在到达最短时间时出块
* 如果一直没有交易要，在到达最长出块时间时也会出块

#### 合约的发布和调用
* 发布合约时需要指定发布到哪条链上
* 调用合约时只能调用本链上的合约，不能跨链调用合约
* 合约内部转调其他合约时，不能直接调用跨链合约

#### 程序版本升级的相关问题
* 参照NEO的方案，不同版本的节点可以在同一个P2P网络里运行
* 如果有修改到网络消息结构，需要让所有节点都更新到最新版本才能运行
* 如果有数据存储格式上的修改，不需要强制更新所有节点
  * 因为每个节点各自存储和读取数据，所以不会造成影响

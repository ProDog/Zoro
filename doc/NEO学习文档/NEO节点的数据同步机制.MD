# NEO节点的数据同步机制
---
### 基础知识
* NEO采用P2P网络结构，这种结构决定了以下特征
  * 每个节点上运行相同的程序逻辑
  * 理论上每个节点保存的区块和交易数据应该相同
* 需要同步的数据
  * `Header:`区块头
  * `Block:`区块
  * `Transaction:`交易
* 清单和数据
  * 在发送一个具体的数据前，会先发一次该数据的Hash，作为该数据的清单，并将要发送的数据缓存起来
  * 节点在收到清单后，先依次判断清单中的数据是否已经请求过，如果没有，再向对方发送正式请求该数据的消息
  * 收到对方正式请求数据的消息，从缓存中取出数据，发送给对方
  * 除了避免重复请求相同的数据，在广播清单前，会检查该数据的Hash是否在30秒内已经发送过，避免P2P网络结构造成的循环广播
  
### 各种数据的同步流程

#### 节点的版本信息
  * 在两个节点建立网络连接后，会立刻互发自身的节点版本信息
  * 版本信息里包括节点的程序版本号，网络端口号，区块高度等数据
  * 收到版本信息后，会反馈一个确认消息
  * 如果本地的区块高度小于远程节点的区块高度，会向该节点请求本地没有的区块头

#### 远程节点的地址列表
  * 在第一次启动节点时，会先连接上protocol.json里记录的5个seed节点  
  * 本地节点会向已连接上的远程节点发送"getaddr"消息，请求该节点已连接的节点地址列表
  * 收到"getaddr"后，会将本地已连接的所有节点地址随机填入列表，最多200个，用"addr"消息发送给对方
  * 收到"addr"后，本地节点会记录这些地址，以便之后向这些地址请求连接
  * 本地节点在关闭程序时，会把这些地址保存到本地文件"peers.dat"里
  * 在启动节点时，会加载"peers.dat"，并尝试和这些节点建立连接

#### 区块头的同步流程
  * 两个节点建立连接后，会根据双方的区块高度，主动向对方请求自己没有的区块头（发"getheaders"消息）
  * 收到用"getheaders"消息后，会从对方请求的区块高度开始，依次从数据库获取区块头数据，发回给对方，一次最多发送2000个区块头 （发"headers"消息）
  * 收到"headers"消息后，将数据记录到BlockChain中，并继续请求还未同步过的区块头数据

#### 区块数据的同步流程
##### 同步区块链上已出块的区块数据
  * 两个节点建立连接后，如果本地的区块高度小于远程节点，则会向对方请求同步区块数据（发"getblocks"消息）
  * 收到"getblocks"消息后，向对方发送区块的Hash列表，一次最多发送500个（发"inv"消息）
  * "inv"消息可以理解为自己能向对方提供的数据清单，能承载Block、Transaction和Consensus三种数据
  * 收到"inv"消息后，排除掉已经请求过的，再发送消息，正式请求需要的区块数据（发"getdata"消息）
  * 收到"getdata"消息后，根据消息体里的Hash列表，将对方请求的区块数据依次发送给对方（每个block发一次"block"消息）
  * 收到"block"消息后，将区块数据记录到`LevelDBBlockChain`的缓存区里，等待保存到LevelDB数据库，并广播转发给其他远程节点

##### 通过共识，生成新的区块
  * 当共识节点完成共识，生成一个新的区块时，会直接广播该区块的清单（"inv"）
  * 收到区块数据的清单后，排除掉已请求过的，再发送消息，正式请求需要的区块数据（"getdata"）
  * 后续流程同上

#### 交易数据的同步流程  
##### RPC方式收到的新交易请求
  * RpcServer收到新的交易请求后，把该请求转给本地节点处理（"sendrawtransaction"）
  * 本地节点立刻验证该交易，通过后把这些交易数据广播给其他节点（"inv"）
  * 远程节点收到交易数据的清单后，排除掉已请求过的，再正式向对方请求余下的交易数据（"getdata"）
  * 本地节点收到"getdata"消息后，根据消息体里的Hash列表，将对方请求的交易数据依次发送给对方（每个交易发一次"tx"消息）
  * 远程节点收到"tx"消息后，将交易记录到本地节点的临时缓存区里，等待后台线程进行验证
  * 远程节点通过验证后，把交易数据的清单广播给其他节点（"inv")

##### 远程节点广播的交易数据
  * 收其他节点广播的交易数据清单（"inv"）
  * 请求并接收具体的交易数据（"getdata"->"tx"）
  * 先将交易数据缓存，等待本地节点进行验证
  * 通过验证后，广播给其他节点（"inv"）

#### 共识数据的通信流程
  * 共识过程中会发送三种共识消息：
    * `PrepareRequest`
      * 开始共识时由议长广播
      * 消息体里包括新区块头的签名和所有待共识交易的Hash
    * `PrepareResponse`
      * 议员收到`RepareRequest`，成功校验需要共识的签名和交易数据后广播
      * 消息体里有议员签名的新区块头
    * `ChangeView`
      * 共识节点希望变更视图时发送
      * 消息体里有期望的新视图编号
  * 通信流程
    * 共识节点广播出一个共识消息的清单（"inv")
    * 收到清单后，排除掉已请求过的，再发送消息，正式请求该共识消息（"getdata"）
    * 收到"getdata"消息后，根据Hash，向对方发送对应的共识消息（"consensus"）

